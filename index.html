<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://www.thingsjar.com').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Thingsjar">
<meta property="og:url" content="https://www.thingsjar.com/index.html">
<meta property="og:site_name" content="Thingsjar">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Thingsjar">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.thingsjar.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Thingsjar</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Thingsjar</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Plug and Play</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.thingsjar.com/2019/12/25/20191225043600/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thingsjar">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thingsjar">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/25/20191225043600/" class="post-title-link" itemprop="url">How to pubilish your Hexo blog hosted on Github with your ipad gracefully?</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-25 01:42:25" itemprop="dateCreated datePublished" datetime="2019-12-25T01:42:25+00:00">2019-12-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-26 15:44:53" itemprop="dateModified" datetime="2019-12-26T15:44:53+00:00">2019-12-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HowTo/" itemprop="url" rel="index">
                    <span itemprop="name">HowTo</span>
                  </a>
                </span>
            </span>

          
            <span id="/2019/12/25/20191225043600/" class="post-meta-item leancloud_visitors" data-flag-title="How to pubilish your Hexo blog hosted on Github with your ipad gracefully?" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/25/20191225043600/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/25/20191225043600/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In the last days, I was on a vacation. I wanted to push my news to my own blog, but the only thing I had with me is my ipad Pro. So I asked myself, is there a way to publish something with ipad <strong>gracefully</strong>?</p>
<p>The answer is: <em>yes, of course!</em></p>
<p>I assume that, you already know how to generate your blog and deploy it on github or your own server with Hexo. If you still have questions about that, you can refer to my last article about it.</p>
<p>My first thought is to get remote access to your server and edit your post directly on it. I’m using Promp2 as my tool to work on a remote server and its performance is satisfying sofar.</p>
<p>However, we are talking about how to edit your post gracefully. In this way, you have to use the command lines and do a lot of work to get your article published, including edit the post, generate the static files and deploy them on git or your own server. Especially if you want to edit your post with many pictures, you have to upload the pictures and rename them first. To add them in the post is not very convenient. If you need to post news very often, this extra work will take a lot of time.</p>
<p>How can you make the process easier, so that you can focus on your writing?</p>
<p>This picture below shows this new process.</p>
<p><img src="/images/20191225043600/photo.jpeg" alt="image"></p>
<p>I made a git repository (Repo 1) with the hexo source files. With a tool from app store called Working Copy, you can get access to your repo and do the normal work such as pull, commit and push easily.</p>
<p>With this tool, you can add your post files in this application and push them to your remote repo.</p>
<p>In order to automate the process on the server, you have to setup a webhook, which allows you to trigger a bash script on your server after every push. This script will pull the changes from Repo 1, clean the hexo static files, generate the new static files and deploy them to the repository Repo 2, which you use to host your blog. After that, this script will also push the whole scource files to remote Repo 1 again, so that it is sychronized among your server, your ipad and github.</p>
<p>However, it still doesn’t solve the problem with inserting pictures. You can upload your pictures on a image host. And use the url you get from that in your posts. But normally, there are many restrictions about the size and number of your pictures, that you are allowed to upload. Therefore I prefer to host the pictures on my own site.</p>
<p>You can use Working Copy to upload the pictures manuelly to your repo and insert them in your markdown file. But in this case, you have to take care of managing the images yourself.</p>
<p>There is another way, which make it much easier and faster. There are a lot of markdown editors in app store. I’m using an app called noto. Using this tool, you can focus on editing your blog and use the functions such as insert a picture or formula just as in microsoft word. After your post is finished, you can export your file as a pdf, html or markdown.</p>
<p>If you export it as markdown, you will get a folder with the .md file and all the pictures you used in your file. And the images in the md file are inserted directly with their names. The image link looks like this:<code>![image](NameOfImage.jpg)</code></p>
<p>But hexo requires you to add the images in the folder …/hexo/source/image/. I prefer to make a subfolder for each post I have in the image folder. So the image should be uploaded to …/hexo/source/image/NameOfPost/. Besides that, you need to move your md files in the folder …/hexo/source/_posts. And the url of the image in your md file should be <code>![image](/image/NameOfPost/NameOfImage.jpg)</code><br>Therefore, instead of directly inserting the files to the …/hexo/source/ folder, I upload the whole folder generated by noto to a buffer folder named “update”. On the server side, you have to add an extra function with your script, which can edit the md file and move it to the _posts folder. And then make a new folder with the same name as your post in the images folder. After that, it can move all the pictures to this folder. </p>
<p>In order to use this function, you have to setup the webhook in your github repository (Repo1) first. With the webhook setup from github, everytime after something is pushed, it will send a POST request to your server. </p>
<p>On your server, you have to install the <a href="https://github.com/rvagg/github-webhook-handler#readme" target="_blank" rel="noopener">github-webhook-handler</a>.</p>
<p>After that, you need to create following two files on your server:</p>
<ul>
<li>webhook.js: This file will listen to the port (in this case, port number = 12345). And this webhook.js will get the event posted by the webhook and trigger the deploy.sh script to run.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var http &#x3D; require(&#39;http&#39;)</span><br><span class="line">var createHandler &#x3D; require(&#39;github-webhook-handler&#39;)</span><br><span class="line">var handler &#x3D; createHandler(&#123; path: &#39;&#x2F;&#39;, secret: &#39;Yoursecret&#39; &#125;)</span><br><span class="line">function run_cmd(cmd, args, callback) &#123;</span><br><span class="line">  var spawn &#x3D; require(&#39;child_process&#39;).spawn;</span><br><span class="line">  var child &#x3D; spawn(cmd, args);</span><br><span class="line">  var resp &#x3D; &quot;&quot;;</span><br><span class="line">  child.stdout.on(&#39;data&#39;, function(buffer) &#123; resp +&#x3D; buffer.toString(); &#125;);</span><br><span class="line">  child.stdout.on(&#39;end&#39;, function() &#123; callback (resp) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http.createServer(function (req, res) &#123;</span><br><span class="line">  handler(req, res, function (err) &#123;</span><br><span class="line">    res.statusCode &#x3D; 404</span><br><span class="line">    res.end(&#39;no such location&#39;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).listen(12345)</span><br><span class="line"></span><br><span class="line">handler.on(&#39;error&#39;, function (err) &#123;</span><br><span class="line">  console.error(&#39;Error:&#39;, err.message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">handler.on(&#39;push&#39;, function (event) &#123;</span><br><span class="line">  console.log(&#39;Received a push event for %s to %s&#39;,</span><br><span class="line">    event.payload.repository.name,</span><br><span class="line">    event.payload.ref);</span><br><span class="line">    run_cmd(&#39;sh&#39;, [&#39;.&#x2F;deploy.sh&#39;,event.payload.repository.name], function(text)&#123; console.log(text) &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>deploy.sh<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">WEB_PATH&#x3D;&#39;&#x2F;home&#x2F;git&#x2F;Example.git&#39;</span><br><span class="line">HEXO_PATH&#x3D;&#39;&#x2F;home&#x2F;git&#x2F;Example.git&#x2F;hexo&#39;</span><br><span class="line">UPDATE_PATH &#x3D; &#39;&#x2F;home&#x2F;git&#x2F;Example.git&#x2F;update&#39;</span><br><span class="line"></span><br><span class="line"># pull the source files from github to your server</span><br><span class="line">echo &quot;start pulling from thingsjarsrc.git&quot;</span><br><span class="line">cd $WEB_PATH</span><br><span class="line">git pull git@github.com:Example&#x2F;Example.git</span><br><span class="line"></span><br><span class="line"># handle the newly updated posts</span><br><span class="line">cd UPDATE_PATH</span><br><span class="line"></span><br><span class="line">#just in case there is space in your file name. You can change the Internal Field Separator (IFS) to another char and change it back after this process finished.</span><br><span class="line"></span><br><span class="line">MY_SAVEIFS&#x3D;$IFS</span><br><span class="line">IFS&#x3D;$&#39;\%&#39;</span><br><span class="line"></span><br><span class="line">for file in &#x2F;home&#x2F;git&#x2F;Example.git&#x2F;update&#x2F;*</span><br><span class="line">do</span><br><span class="line">  # if the file is a directory (folder)</span><br><span class="line">  if test -d $file</span><br><span class="line">  then</span><br><span class="line">    mdfilename&#x3D;&#39;&#39;</span><br><span class="line">    #set up a new filename for your post, the name will be YYYYMMDDhhmmss</span><br><span class="line">    mdfilename&#x3D;$(date +&quot;%Y%m%d%H%M%S&quot;)</span><br><span class="line">    # then iterate in the folder to finde the .md file</span><br><span class="line">    for subfile in $file&#x2F;*   #&#96;ls $file | sed &quot;s:^:$file&#x2F;:&quot;&#96;</span><br><span class="line">    do</span><br><span class="line">      if [ -f $subfile ] &amp;&amp; [ &quot;$&#123;subfile##*.&#125;&quot;x &#x3D; &quot;md&quot;x ]</span><br><span class="line">      then</span><br><span class="line">        # change the image link ![image](....jpg) to ![image](&#x2F;image&#x2F;mdfilename&#x2F;...jpg)</span><br><span class="line">        sed -i &quot;s&#x2F;\!\[image\](&#x2F;\!\[image\](\&#x2F;image\&#x2F;&quot;$mdfilename&quot;\&#x2F;&#x2F;g&quot; $subfile</span><br><span class="line">        # rename the md file and move it ot the _posts folder</span><br><span class="line">        mv $subfile &quot;&#x2F;home&#x2F;git&#x2F;thingsjarsrc.git&#x2F;hexo&#x2F;source&#x2F;_posts&#x2F;&quot;&quot;$mdfilename&quot;&quot;.md&quot;</span><br><span class="line">        break</span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">    # move the image files to the ...&#x2F;hexo&#x2F;source&#x2F;image&#x2F; folder</span><br><span class="line">    if [ &quot;$mdfilename&quot;x !&#x3D; &quot;&quot;x ]</span><br><span class="line">    then</span><br><span class="line">      if [ -d &quot;&#x2F;home&#x2F;git&#x2F;thingsjarsrc.git&#x2F;hexo&#x2F;source&#x2F;image&#x2F;&quot;$mdfilename ]</span><br><span class="line">      then</span><br><span class="line">        mkdir &quot;&#x2F;home&#x2F;git&#x2F;thingsjarsrc.git&#x2F;hexo&#x2F;source&#x2F;image&#x2F;&quot;$mdfilename</span><br><span class="line">      fi</span><br><span class="line">      mv $file &quot;&#x2F;home&#x2F;git&#x2F;thingsjarsrc.git&#x2F;hexo&#x2F;source&#x2F;image&#x2F;&quot;$mdfilename</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">IFS&#x3D;$MY_SAVEIFS</span><br><span class="line"></span><br><span class="line">cd $HEXO_PATH</span><br><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br><span class="line"></span><br><span class="line">cd $WEB_PATH</span><br><span class="line">git add .</span><br><span class="line">git commit -a -m &quot;update&quot;</span><br><span class="line">git push -uf Example master</span><br><span class="line">echo &quot;done&quot;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Of course, you need to grant your user with the execution right of the deploy.sh script.</p>
<p>To summarize, with all the work mentioned above, your final work process will be looking like this:</p>
<ol>
<li>You edit your post in noto and export it in the folder update. In Working Copy, there is an option to make the folder update automatically sychronized.</li>
<li>You have to push the new commits to your github repo.</li>
</ol>
<p>After these two steps, your server and github will do the rest of the work. After few miniutes, your hexo blog will be updated.</p>
<p>Talking about iPad, people always consider it as a gaming device, with which you can watch film or play games. But after iPadOS is published, many new functions are available now. For example, you can manage your files in your portable SSD via Type-C USB. Still, it has a lot of restrictions as a working tool. You have the feeling of being tied and working in a small space with few freedom. However, it has the convenience to be used while travling. Moreover, with the Apple Pencile, you can draw things easily. I also recommend the Logic smart cover with keyboard, which is very comfortable to type with. With this solution, you can pack your ipad in your bag and update your hexo blog anywhere you like.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.thingsjar.com/2019/10/22/Github+Hexo+Mac%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thingsjar">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thingsjar">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/22/Github+Hexo+Mac%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">Github+Hexo+Mac 博客部署指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-22 00:36:45" itemprop="dateCreated datePublished" datetime="2019-10-22T00:36:45+00:00">2019-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-26 19:12:43" itemprop="dateModified" datetime="2019-12-26T19:12:43+00:00">2019-12-26</time>
              </span>

          
            <span id="/2019/10/22/Github+Hexo+Mac%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" class="post-meta-item leancloud_visitors" data-flag-title="Github+Hexo+Mac 博客部署指南" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/10/22/Github+Hexo+Mac%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/10/22/Github+Hexo+Mac%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Hexo-配置"><a href="#Hexo-配置" class="headerlink" title="Hexo 配置"></a>Hexo 配置</h3><h4 id="安装nvm"><a href="#安装nvm" class="headerlink" title="安装nvm"></a>安装nvm</h4><p><code>$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash</code></p>
<p>或者</p>
<p><code>$ wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash</code></p>
<p><a href="https://github.com/creationix/nvm#install-script" target="_blank" rel="noopener">nvm官方文档</a></p>
<h4 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h4><p><code>$ nvm install stable</code></p>
<p>nvm 自动选择安装稳定Node版本</p>
<p><a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node官方文档</a></p>
<h4 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h4><p><code>$ npm install -g hexo-cli</code></p>
<p><a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">Hexo官方文档</a></p>
<h4 id="安装hexo-deployer-git"><a href="#安装hexo-deployer-git" class="headerlink" title="安装hexo-deployer-git"></a>安装hexo-deployer-git</h4><p><code>$ npm install hexo-deployer-git --save</code></p>
<h4 id="安装hexo-renderer-scss"><a href="#安装hexo-renderer-scss" class="headerlink" title="安装hexo-renderer-scss"></a>安装hexo-renderer-scss</h4><p><code>$ npm install --save hexo-renderer-scss</code></p>
<h4 id="初始化博客"><a href="#初始化博客" class="headerlink" title="初始化博客"></a>初始化博客</h4><p>建立项目文件夹，例如：<code>mkdir hexo</code></p>
<p>进入建立的项目文件夹，例如：<code>cd hexo</code></p>
<p>执行Hexo初始化命令 <code>hexo init</code></p>
<h4 id="生成网站"><a href="#生成网站" class="headerlink" title="生成网站"></a>生成网站</h4><p><code>$ hexo g</code></p>
<h4 id="启动本地服务器"><a href="#启动本地服务器" class="headerlink" title="启动本地服务器"></a>启动本地服务器</h4><p><code>$ hexo s</code></p>
<p>在浏览器中打开默认网页<a href="localhost:4000">localhost:4000</a>可以预览网页运行效果</p>
<p><em>Ctrl + C</em> 终止运行本地服务器</p>
<h4 id="选择Hexo主题"><a href="#选择Hexo主题" class="headerlink" title="选择Hexo主题"></a>选择Hexo主题</h4><p>参考<a href="https://hexo.io/themes/" target="_blank" rel="noopener">hexo官方主题网页</a>选择喜欢的主题并根据主题文档进行安装。</p>
<p>例如：</p>
<p>如果安装<a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">NexT主题</a>，可以根据文档运行如下命令，下载主题至themes目录中，文件夹命名为next。</p>
<p><code>$ cd hexo</code></p>
<p><code>$ git clone https://github.com/theme-next/hexo-theme-next themes/next</code></p>
<p>或参考<a href="https://github.com/theme-next/hexo-theme-next/blob/master/docs/INSTALLATION.md" target="_blank" rel="noopener">这里</a>列出的其他方法。</p>
<p>利用nano修改_config.yml中指定的主题。</p>
<p><code>$ sudo nano _config.yml</code></p>
<p>利用Ctrl + W 搜索theme的位置，并修改主题为next，注意格式，冒号后面要添加空格。</p>
<p><code>theme: next</code></p>
<p>再次执行<code>hexo g</code>命令重新生成博客页面，可以运行<code>hexo s</code>在本地服务器localhost:4000查看新生成的页面。</p>
<h3 id="Github-配置"><a href="#Github-配置" class="headerlink" title="Github 配置"></a>Github 配置</h3><h4 id="注册Github账户"><a href="#注册Github账户" class="headerlink" title="注册Github账户"></a>注册Github账户</h4><p>访问<a href="https://github.com" target="_blank" rel="noopener">Github主页</a>并注册一个账户。</p>
<h4 id="新建一个Github仓库"><a href="#新建一个Github仓库" class="headerlink" title="新建一个Github仓库"></a>新建一个Github仓库</h4><p>登陆后，点击Repositories-&gt;New，新建一个仓库(Repository)。</p>
<h4 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h4><p>安装homebrew</p>
<p><code>$ /usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</code></p>
<p>利用homebrew安装git</p>
<p><code>$ brew install git</code></p>
<h4 id="创建SSH-Key，-配置Git"><a href="#创建SSH-Key，-配置Git" class="headerlink" title="创建SSH Key， 配置Git"></a>创建SSH Key， 配置Git</h4><p>设置username和email</p>
<p><code>$ git config --global user.name &quot;ReplaceWithYourUserName&quot;</code></p>
<p><code>$ git config --global user.email &quot;ReplaceWithYourEmail&quot;</code></p>
<p>通过终端命令创建SSH Key</p>
<p><code>$ ssh-keygen -t rsa -C &quot;ReplaceWithYourEmail&quot;</code></p>
<p>利用pbcopy命令复制public key到剪贴板</p>
<p><code>pbcopy &lt; ~/.ssh/id_rsa.pub</code></p>
<p>登陆Github，进入Repository设置，选择Depoly keys -&gt; Add Deploy key，并将剪贴版中的public key 粘贴到网页中，勾选Allow write access</p>
<p>可以登陆下面命令，看看是否设置成功，<a href="mailto:git@github.com">git@github.com</a>部分不要修改：</p>
<p><code>ssh -T git@github.com</code></p>
<p>如果是下面反馈</p>
<p><code>The authenticity of host &#39;github.com (207.97.227.239)&#39; can&#39;t be established.
RSA key fingerprint is xxxxxx Are you sure you want to continue connecting (yes/no)?</code></p>
<p>输入yes并确认。</p>
<h4 id="修改配置-config-yml文件"><a href="#修改配置-config-yml文件" class="headerlink" title="修改配置_config.yml文件"></a>修改配置_config.yml文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https:&#x2F;&#x2F;ReplaceWihYourName.github.com&#x2F;ReplaceWithYourRepo</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<p>注意冒号后面的空格。</p>
<p>同时修改url和root路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url: https:&#x2F;&#x2F;ReplaceWihYourName.github.com&#x2F;ReplaceWithYourRepo</span><br><span class="line">root: &#x2F;ReplaceWithYourRepo</span><br></pre></td></tr></table></figure>

<h4 id="发布到GitHub上"><a href="#发布到GitHub上" class="headerlink" title="发布到GitHub上"></a>发布到GitHub上</h4><p><code>hexo d</code>生成网页后，利用命令<code>hexo d</code>发布到GitHub上</p>
<p>或者在生成网站同时发布：<code>hexo g -d</code></p>
<p>在浏览器输入网址 “<a href="https://ReplaceWihYourName.github.com/ReplaceWithYourRepo“" target="_blank" rel="noopener">https://ReplaceWihYourName.github.com/ReplaceWithYourRepo“</a> 查看页面。</p>
<h4 id="发表新文章"><a href="#发表新文章" class="headerlink" title="发表新文章"></a>发表新文章</h4><p><code>$ hexo n &quot;文章标题&quot;</code></p>
<p>执行命令后，会在hexo\source_posts 中生成一个md文件，用编辑器打开编写即可。</p>
<p>编辑完文章，运行命令<code>hexo d -g</code>将文章发布到GitHub。</p>
<h4 id="Markdown文章编辑"><a href="#Markdown文章编辑" class="headerlink" title="Markdown文章编辑"></a>Markdown文章编辑</h4><p>Markdown的语法非常简单易懂，可以参考<a href="https://www.jianshu.com/p/q81RER" target="_blank" rel="noopener">献给写作者的 Markdown 新手指南</a>。</p>
<h3 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h3><h4 id="域名申请"><a href="#域名申请" class="headerlink" title="域名申请"></a>域名申请</h4><p>可以在namecheap，Godaddy或者阿里云等网站上选择喜欢的域名付费申请。</p>
<h4 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h4><p>为申请的域名添加一条CNAME记录，将它指向github的url，例如：</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Host</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>CNAME Record</td>
<td>www</td>
<td>ReplaceWithYourUsername.github.io</td>
</tr>
</tbody></table>
<p>具体设置方法请参考GitHub官方文档。</p>
<h4 id="HTTPS设置"><a href="#HTTPS设置" class="headerlink" title="HTTPS设置"></a>HTTPS设置</h4><p>为了网站的安全性，有必要给绑定的域名申请一个HTTPS证书（免费）。</p>
<p>只需在Repo的设置页面中勾选Enforce Https选项。</p>
<p>如果该选项不能勾选， 可以现将Custom domain清空并保存，然后重新输入要绑定的网址。</p>
<p>如果此时还不能勾选，有可能该证书申请需要更长时间。</p>
<h4 id="CNAME文件"><a href="#CNAME文件" class="headerlink" title="CNAME文件"></a>CNAME文件</h4><p>在博客项目目录的source文件夹中，创建一个CNAME文件，存储个人域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在source目录下</span><br><span class="line">echo story.wavky.com &gt; CNAME</span><br></pre></td></tr></table></figure>

<p>清理Hexo缓存并重新生成发布</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br></pre></td></tr></table></figure>
<p><em>引用</em></p>
<ul>
<li><a href="https://www.jianshu.com/p/cb0750324e26" target="_blank" rel="noopener"><em>使用Hexo搭建GitHub博客（2018年Mac版）作者：Wavky</em></a></li>
<li><a href="https://my.oschina.net/ryaneLee/blog/638440" target="_blank" rel="noopener"><em>【2018更新】小白独立搭建博客–Github Pages和Hexo简明教程</em></a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.thingsjar.com/2019/01/22/2019-01-22-%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BESense-HAT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thingsjar">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thingsjar">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/22/2019-01-22-%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BESense-HAT/" class="post-title-link" itemprop="url">玩转树莓派Sense HAT</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-22 00:36:45" itemprop="dateCreated datePublished" datetime="2019-01-22T00:36:45+00:00">2019-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-26 19:08:35" itemprop="dateModified" datetime="2019-12-26T19:08:35+00:00">2019-12-26</time>
              </span>

          
            <span id="/2019/01/22/2019-01-22-%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BESense-HAT/" class="post-meta-item leancloud_visitors" data-flag-title="玩转树莓派Sense HAT" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/01/22/2019-01-22-%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BESense-HAT/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/22/2019-01-22-%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BESense-HAT/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-什么是-Sense-HAT"><a href="#1-什么是-Sense-HAT" class="headerlink" title="1. 什么是 Sense HAT"></a>1. 什么是 Sense HAT</h4><p>Sense HAT是Raspberry Pi的附加板，原本为Astro Pi设计，在2015年登上国际空间站。</p>
<p>它有一块8x8的LED阵列，还有一个五个按钮的操纵杆，同时还装备以下传感器：</p>
<ul>
<li>陀螺仪传感器</li>
<li>加速度传感器</li>
<li>磁传感器</li>
<li>温度传感器</li>
<li>气压传感器</li>
<li>湿度传感器</li>
</ul>
<h4 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h4><p>如同，把Sense hat 直接插到树莓派的针脚阵列上即可使用。</p>
<p><img src="/images/IMG_3778.JPG" alt="IMG_3778"></p>
<h4 id="3-第一步"><a href="#3-第一步" class="headerlink" title="3.第一步"></a>3.第一步</h4><p>启动树莓派之后，需要首先下载安装一个Sense HAT的python 库，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br><span class="line">sudo apt-get install sense-hat</span><br></pre></td></tr></table></figure>

<p>我在之后调用这个python库的时候，出现了一个错误：</p>
<p>Cannot detect RPi-Sense FB device![Bildschirmfoto 2019-01-14 um 23.50.12](/images/Bildschirmfoto 2019-01-14 um 23.50.12.png)</p>
<p>原因是Sense HAT并没有被树莓派识别，于是手动加载Sense-HAT，具体做法是打开<code>/boot/config.txt</code>文件并在最后加上一行`dtoverlay=rpi-sense，然后reboot树莓派，Sense-HAT顺利加载。</p>
<p>可以跟着教程<a href="https://www.raspberrypi.org/learning/getting-started-with-the-sense-hat/worksheet/" target="_blank" rel="noopener">Getting Started with the Sense HAT</a>学习一些基本的用法。</p>
<h4 id="4-一些函数"><a href="#4-一些函数" class="headerlink" title="4. 一些函数"></a>4. 一些函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sense_hat <span class="keyword">import</span> SenseHat</span><br><span class="line">sense = SenseHat()</span><br><span class="line">sense.show_message(<span class="string">"Hello world"</span>,text_colour=(R,G,B), back_colour=(R,G,B), scroll_speed=<span class="number">0.1</span>) <span class="comment">#在led上显示滚动信息</span></span><br><span class="line">sense.show_letter(<span class="string">"A"</span>) <span class="comment">#在led上显示一个字母</span></span><br><span class="line">sense.set_pixel(<span class="number">2</span>, <span class="number">2</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)) <span class="comment">#设置一个pixel的颜色</span></span><br><span class="line">g = (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>) <span class="comment"># Green</span></span><br><span class="line">b = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment"># Black</span></span><br><span class="line">creeper_pixels = [</span><br><span class="line">    g, g, g, g, g, g, g, g,</span><br><span class="line">    g, g, g, g, g, g, g, g,</span><br><span class="line">    g, b, b, g, g, b, b, g,</span><br><span class="line">    g, b, b, g, g, b, b, g,</span><br><span class="line">    g, g, g, b, b, g, g, g,</span><br><span class="line">    g, g, b, b, b, b, g, g,</span><br><span class="line">    g, g, b, b, b, b, g, g,</span><br><span class="line">    g, g, b, g, g, b, g, g</span><br><span class="line">]</span><br><span class="line">sense.set_pixels(creeper_pixels) <span class="comment">#设置整个led阵列显示图像</span></span><br><span class="line">sense.set_rotation(<span class="number">180</span>) <span class="comment">#旋转显示一定角度, 参数只接受0，90，180，270度</span></span><br><span class="line">sense.flip_h() <span class="comment">#水平翻转</span></span><br><span class="line">sense.flip_v() <span class="comment">#垂直翻转</span></span><br><span class="line">pressure = sense.get_pressure() <span class="comment">#获取大气压力</span></span><br><span class="line">temperature = sense.get_temperature() <span class="comment">#获取温度</span></span><br><span class="line">humidity = sense.get_humidity() <span class="comment">#获取湿度</span></span><br><span class="line">o = sense.get_orientation() <span class="comment">#获取陀螺仪的数值</span></span><br><span class="line">pitch = o[<span class="string">"pitch"</span>]</span><br><span class="line">roll = o[<span class="string">"roll"</span>]</span><br><span class="line">yaw = o[<span class="string">"yaw"</span>]</span><br><span class="line">acceleration = sense.get_accelerometer_raw() <span class="comment">#获取加速度传感器树脂</span></span><br><span class="line">x = acceleration[<span class="string">'x'</span>]</span><br><span class="line">y = acceleration[<span class="string">'y'</span>]</span><br><span class="line">z = acceleration[<span class="string">'z'</span>]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> event <span class="keyword">in</span> sense.stick.get_events(): <span class="comment">#获取摇杆的动作</span></span><br><span class="line">        print(event.direction, event.action)</span><br><span class="line">sense.stick.direction_up = pushed_up <span class="comment">#定义摇杆操作触发的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pushed_up</span><span class="params">(event)</span>:</span></span><br><span class="line">      print(event)</span><br></pre></td></tr></table></figure>

<h4 id="5-下一步"><a href="#5-下一步" class="headerlink" title="5. 下一步"></a>5. 下一步</h4><p>可以去<a href="https://trinket.io/sense-hat" target="_blank" rel="noopener">trinket</a>上下载一些游戏的代码体验一下，然后编写自己的应用。</p>
<h4 id="6-关于温度传感器"><a href="#6-关于温度传感器" class="headerlink" title="6. 关于温度传感器"></a>6. 关于温度传感器</h4><p>测试了一下SenseHat读出来的温度数值，在室温情况下有35度。原因是SenseHAT的温度传感器在树莓派CPU的正上方，所以CPU产生的热量会影响温度的数值，尝试采用<code>sense.get_temperature_from_pressure()</code>读出压力传感器里温度的数值，也大概是35度。</p>
<p>目前想到的一个解决办法是加大SenseHAT和树莓派的距离，但是这样做的缺点是，整体的体积会变得更大。网上还有的人通过CPU的温度设计了一个函数进行补偿，但是这样准确性也并不高。</p>
<p>尝试在SenseHat和树莓派件加一层隔热材料，如下图，加了一块纸板。</p>
<p><img src="/images/IMG_3779.JPG" alt="IMG_3779"></p>
<p>SenseHat温度恢复正常：</p>
<p>![Bildschirmfoto 2019-01-15 um 02.51.47](/images/Bildschirmfoto 2019-01-15 um 02.51.47.png)</p>
<p>当然随着树莓派工作时间变长，热量散发不出去，势必会影响到SenseHat的温度传感器。纸板的隔热效果一般，可以采用更好的隔热材料，或者选用其他的温度传感器，如DHT22。</p>
<h4 id="7-做点有趣的东西"><a href="#7-做点有趣的东西" class="headerlink" title="7.做点有趣的东西"></a>7.做点有趣的东西</h4><p><a href="https://www.thingsjar.com/blog/2019/01/22/Raspberry-Pi-SenseHAT-ShakeReMote/">基于树莓派和sensehat的智能“摇”控器（摇一摇，控制你的智能设备）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.thingsjar.com/2019/01/22/2019-01-22-Raspberry-Pi-SenseHAT-ShakeReMote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thingsjar">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thingsjar">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/22/2019-01-22-Raspberry-Pi-SenseHAT-ShakeReMote/" class="post-title-link" itemprop="url">Raspberry Pi + SenseHAT = ShakeReMote</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-22 00:32:55" itemprop="dateCreated datePublished" datetime="2019-01-22T00:32:55+00:00">2019-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-26 19:08:35" itemprop="dateModified" datetime="2019-12-26T19:08:35+00:00">2019-12-26</time>
              </span>

          
            <span id="/2019/01/22/2019-01-22-Raspberry-Pi-SenseHAT-ShakeReMote/" class="post-meta-item leancloud_visitors" data-flag-title="Raspberry Pi + SenseHAT = ShakeReMote" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/01/22/2019-01-22-Raspberry-Pi-SenseHAT-ShakeReMote/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/22/2019-01-22-Raspberry-Pi-SenseHAT-ShakeReMote/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-Intro"><a href="#1-Intro" class="headerlink" title="1. Intro"></a>1. Intro</h2><p>Nowadays, there are more and more smart devices in a modern house. You can use Alexa or Siri to control your lights, switches or other elektronic devices, such as a cleaning robot with voice. In the meanwhile, you can know the room temperature and humidity in every room using different sensors. In the near future, there won’t be any physical switches, because every devices in your home can see, hear, learn and control themselves. And based on the automation, your home life will be more convenient, energy saving and efficient.</p>
<p>Using a Raspberry Pi and a SenseHat, I made a prototype of an interesting device, with which you can control your smart devices with a shake. It has an advantage over voice control with Alexa, especially when you cannot talk. The LED array shows the device you can control. You can personalise them by changing it with the picture you like. This remote control can recognise how hard you’ve shaked it. If you shake it lightly, it turn on or off the device you choose, or change the colour of the light. If you shake it hardly, it will start a party mode by playing you music, turning on all color lights, and showing a spining wein glass with changing colors on the display. The color of the led changes simutaniously with the color of your light stripe.</p>
<p>Now, lets take a look how it looks like.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/6SWA7YpuF9c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



<h2 id="2-What-do-you-need-for-that"><a href="#2-What-do-you-need-for-that" class="headerlink" title="2. What do you need for that"></a>2. What do you need for that</h2><p>First of all, you need a raspberry pi as a home assistant server (lets name it Server Pi) and you can connect your smart devices to the server. I used the hassio system, which has a user friendly frontend and you can add your devices and realise the automation functions with script easily. It‘s a platform, which allows many different components, so that you don’t have to worry about the compatibility of your device.</p>
<p>The hassio system also exposes an http API to the user. And this enables us to connect to the home assistant server and control the devices using another raspberry pi (It will be refered to as Remote Pi). To make the remote control more interesting, we add a SenseHAT to it. The senseHat is equiped with acceleration sensors and a 8x8 led array, which will be used in this project.</p>
<h2 id="3-Connection-between-Remote-Pi-and-Server-Pi"><a href="#3-Connection-between-Remote-Pi-and-Server-Pi" class="headerlink" title="3. Connection between Remote Pi and Server Pi"></a>3. Connection between Remote Pi and Server Pi</h2><p>To send the control orders from remote to server and get the status of devices from server to remote, we need a two way connection between them. There are different way to do that, such as MQTT, http and websocket. In this project, i chose WebSocket, because its a bi-direction channel. </p>
<p>To enable the conenction, first of all, you need an authentication to connect your application (the remote) to the server.  The home assistsant adopted the <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">OAuth 2 specification</a> and <a href="https://indieauth.spec.indieweb.org/" target="_blank" rel="noopener">OAuth 2 IndieAuth extension</a> for generating clients. I used a long-lived access token, so that I dont have the trouble of maintaning and refreshing the token. You can refer to <a href="https://developers.home-assistant.io/docs/en/auth_api.html" target="_blank" rel="noopener">Authentication API</a> to get more information about authentication.</p>
<p>To use WebSocket API, you have to add the <a href="https://www.home-assistant.io/components/websocket_api/" target="_blank" rel="noopener">websocket_api component</a> to your configuration.yaml file. On the remote pi, i used <a href="https://pypi.org/project/websocket-client/" target="_blank" rel="noopener">WebSocket-client</a> as a client.</p>
<p>With  <a href="https://pypi.org/project/websocket-client/" target="_blank" rel="noopener">WebSocket-client</a>, you can first connect to <code>ws://localhost:8123/api/websocket</code>. The WebSocket API of home assistant uses JSON as the message format. So after connection, you will firstly get a <code>auth_required</code> message:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"type"</span>: <span class="string">"auth_required"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You have to send back <code>auth</code> message with  your token like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"auth"</span>,</span><br><span class="line">  <span class="string">"access_token"</span>: <span class="string">"ABCDEFGHIJKLMNOPQ"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If the authentication is successful, the server will send back <code>auth_ok</code> message like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"auth_ok"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Otherwise, the server will send back <code>auth_invalid</code> message.</p>
<p>After the connection is built and the authentication is successful, you can send command with a websocket message like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ws.send(json.dumps(&#123;</span><br><span class="line">                <span class="string">"id"</span>: id,</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                <span class="string">"domain"</span>: <span class="string">"light"</span>,</span><br><span class="line">                <span class="string">"service"</span>: <span class="string">"turn_off"</span>,</span><br><span class="line">                <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                <span class="string">"entity_id"</span>: <span class="string">"light.stehlampe"</span></span><br><span class="line">                &#125;</span><br><span class="line">                &#125;))</span><br></pre></td></tr></table></figure>

<p>You can also get the status of devices with this message:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ws.send(json.dumps(&#123;</span><br><span class="line">    <span class="string">"id"</span>: id,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"get_states"</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>However, the server will send you back the status of all devices in a JSON format. You have to filter out the device you need.</p>
<p>I used this <a href="https://github.com/keatontaylor/custom_components/blob/master/media_player/alexa.py" target="_blank" rel="noopener">interface</a> from home assistant to Alexa, so that I can use alexa as a loudspeaker to play music. Using the Text-to-Speech function, you can also use alexa to change your text into voice. You need a payload like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"entity_id"</span>: <span class="string">"media_player.bedroom_echo_dot"</span>, <span class="string">"message"</span>: <span class="string">"Test message"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>I also used the function to control the a <a href="https://www.meross.com" target="_blank" rel="noopener">Meross Power strip</a>, however it was quit tricky. The meross devices don’t support home assistant yet, so you cannot use home assistant to controll them directly. However, the meross devices do support <a href="https://ifttt.com/discover" target="_blank" rel="noopener">IFTTT</a>. So you need to set the webhook in IFTTT first to turn on and off the switch. After that, you need to add an <a href="https://www.home-assistant.io/components/input_boolean/" target="_blank" rel="noopener">Input Boolean</a> and set the automation to send the request to turn on and off the switch. After that, you need to send a websocket message like below to toggle the input boolean value.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ws.send(json.dumps(&#123;</span><br><span class="line">                <span class="string">"id"</span>: id,</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                <span class="string">"domain"</span>: <span class="string">"input_boolean"</span>,</span><br><span class="line">                <span class="string">"service"</span>: <span class="string">"turn_on"</span>,</span><br><span class="line">                <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                <span class="string">"entity_id"</span>: <span class="string">"input_boolean.xmas_tree"</span></span><br><span class="line">                &#125;</span><br><span class="line">                &#125;))</span><br></pre></td></tr></table></figure>

<p>The disadvantage of this method is that, there is always a delay by controlling with IFTTT. That’s why it took 5-10 seconds to react. Another disadvantage is that, you cannot get the status of your device easily. You can set the request to turn on the switch, but it dosen’t give you a response if it works or not.</p>
<h2 id="4-The-Code"><a href="#4-The-Code" class="headerlink" title="4. The Code"></a>4. The Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> sense_hat <span class="keyword">import</span> SenseHat</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line">MY_TOKEN=<span class="string">"!!!Replace with the token you get!!!"</span></span><br><span class="line">sense = SenseHat()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">import</span> _thread <span class="keyword">as</span> thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">id = <span class="number">1</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">b = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">dark = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)  <span class="comment"># blue</span></span><br><span class="line">bright = (<span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>)  <span class="comment"># yellow</span></span><br><span class="line">unconnected = (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># red</span></span><br><span class="line">c=(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>) <span class="comment">#white</span></span><br><span class="line">col=(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>)</span><br><span class="line">state = <span class="string">"unknown"</span></span><br><span class="line">resultid=<span class="number">0</span></span><br><span class="line">t0=<span class="number">0</span></span><br><span class="line">partyison=<span class="literal">False</span></span><br><span class="line">pic_makeparty_rotate=<span class="number">270</span></span><br><span class="line"><span class="comment"># Generate a random colour</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pick_random_colour</span><span class="params">()</span>:</span></span><br><span class="line">    random_red = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    random_green = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    random_blue = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">return</span> (random_red, random_green, random_blue)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_stehlampe</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, c, b, b, b, b, b, b,</span><br><span class="line">    b, c, c, c, b, b, b, b,</span><br><span class="line">    b, c, c, c, c, b, b, b,</span><br><span class="line">    b, b, c, c, c, c, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, c, b, c, b, c, b, b</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_led</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, c, b, c, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, c, b, c, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, c, b, c, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, c, b, c, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_kitchen</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, b, b, b, b, b, b, b,</span><br><span class="line">    b, b, b, b, b, b, b, b</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_xmastree</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, b, b, b, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_partylight</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, b, c, c, b, b, b,</span><br><span class="line">    b, b, c, b, b, c, b, b,</span><br><span class="line">    b, c, b, b, b, b, c, b,</span><br><span class="line">    b, c, b, b, b, b, c, b,</span><br><span class="line">    b, c, b, b, b, b, c, b,</span><br><span class="line">    b, b, c, b, b, c, b, b,</span><br><span class="line">    b, b, b, c, c, b, b, b,</span><br><span class="line">    b, b, b, c, c, b, b, b</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_makeparty</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, b, b, b, b, b, b,</span><br><span class="line">    b, c, b, b, b, c, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, c, c, c, c, c, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, b, c, b, b, b, b,</span><br><span class="line">    b, b, c, c, c, b, b, b</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pic_dragonball</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">global</span> b</span><br><span class="line">  <span class="keyword">global</span> c</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    b, b, c, c, c, c, b, b,</span><br><span class="line">    b, c, c, c, c, c, c, b,</span><br><span class="line">    c, c, c, c, c, c, c, c,</span><br><span class="line">    c, b, b, b, b, b, b, c,</span><br><span class="line">    c, b, b, b, b, b, b, c,</span><br><span class="line">    c, c, b, b, b, b, c, c,</span><br><span class="line">    b, c, c, b, b, c, c, b,</span><br><span class="line">    b, b, c, c, c, c, b, b</span><br><span class="line">]</span><br><span class="line">pic_array = [pic_stehlampe, pic_led, pic_kitchen, pic_xmastree, pic_partylight, pic_dragonball]</span><br><span class="line">id_array = [<span class="string">"light.stehlampe"</span>, <span class="string">"light.lichtsstreifen"</span>, <span class="string">"light.kuche"</span>, <span class="string">"input_boolean.xmas_tree"</span>, <span class="string">"input_boolean.party_light"</span>, <span class="string">"input_boolean.dragon_ball"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeparty</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> resultid, id, partyison,i</span><br><span class="line">    partyison=<span class="literal">True</span></span><br><span class="line">    i=<span class="number">1</span></span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"media_player"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"alexa_tts"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"media_player.schwarz"</span>,</span><br><span class="line">    	    <span class="string">"message"</span>: <span class="string">"My dearest baby, let's have some romentic moment. Love you!"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"media_player"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"media_play"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"media_player.schwarz"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"light"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"turn_off"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"light.stehlampe"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"light"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"turn_off"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"light.kuche"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"input_boolean"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"turn_on"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"input_boolean.xmas_tree"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"input_boolean"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"turn_on"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"input_boolean.party_light"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"input_boolean"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"turn_on"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"input_boolean.dragon_ball"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    id+=id</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">while</span> partyison==<span class="literal">True</span>:</span><br><span class="line">        randomcolor(ws, <span class="string">"light.lichtsstreifen"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_state</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> resultid, id</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">        <span class="string">"id"</span>: id,</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"get_states"</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">    resultid = id</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"get state id"</span>+str(id)</span><br><span class="line">    id = id+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pushed_left</span><span class="params">(event)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> event.action == <span class="string">"pressed"</span> <span class="keyword">and</span> partyison==<span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">global</span> i</span><br><span class="line">        <span class="keyword">global</span> resultid</span><br><span class="line">        i = i - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &lt; <span class="number">0</span>:</span><br><span class="line">            i = i + len(id_array)</span><br><span class="line">        get_state()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pushed_right</span><span class="params">(event)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> event.action == <span class="string">"pressed"</span> <span class="keyword">and</span> partyison==<span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">global</span> i</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= len(id_array):</span><br><span class="line">            i = i - len(id_array)</span><br><span class="line">        get_state()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pushed_middle</span><span class="params">(event)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> t0</span><br><span class="line">    <span class="keyword">global</span> id</span><br><span class="line">    <span class="keyword">global</span> i</span><br><span class="line">    <span class="keyword">global</span> id_array</span><br><span class="line">    <span class="keyword">global</span> partyison</span><br><span class="line"></span><br><span class="line">    partywaron=<span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> event.action == <span class="string">"pressed"</span>:</span><br><span class="line">    t0=time.time()</span><br><span class="line">    <span class="keyword">elif</span> event.action == <span class="string">"released"</span>:</span><br><span class="line">    t=time.time()-t0</span><br><span class="line">    <span class="keyword">print</span> t</span><br><span class="line">    <span class="keyword">if</span> t&gt;<span class="number">0.5</span>:</span><br><span class="line">        <span class="keyword">if</span> partyison==<span class="literal">True</span>:</span><br><span class="line">    	partywaron=<span class="literal">True</span></span><br><span class="line">    	partyison=<span class="literal">False</span></span><br><span class="line">        pic_makeparty_rotate=<span class="number">270</span></span><br><span class="line">        i=<span class="number">0</span></span><br><span class="line">        sense.set_rotation(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> id_array:</span><br><span class="line"> 	        ws.send(json.dumps(&#123;</span><br><span class="line">      		    <span class="string">"id"</span>: id,</span><br><span class="line">        	    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">        	    <span class="string">"domain"</span>: j[<span class="number">0</span>:j.find(<span class="string">"."</span>)],  <span class="comment">#"light",</span></span><br><span class="line">        	    <span class="string">"service"</span>: <span class="string">"turn_off"</span>,</span><br><span class="line">        	    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">            	    <span class="string">"entity_id"</span>: j</span><br><span class="line">        	    &#125;</span><br><span class="line">    		    &#125;))</span><br><span class="line">		id=id+<span class="number">1</span></span><br><span class="line">	        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">	    ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"media_player"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"media_pause"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"media_player.schwarz"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">            id+=id</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">	    <span class="keyword">if</span> partywaron==<span class="literal">True</span>:</span><br><span class="line">	    	ws.send(json.dumps(&#123;</span><br><span class="line">                    <span class="string">"id"</span>: id,</span><br><span class="line">                    <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">                    <span class="string">"domain"</span>: <span class="string">"media_player"</span>,</span><br><span class="line">                    <span class="string">"service"</span>: <span class="string">"alexa_tts"</span>,</span><br><span class="line">                    <span class="string">"service_data"</span>: &#123;</span><br><span class="line">                    <span class="string">"entity_id"</span>: <span class="string">"media_player.schwarz"</span>,</span><br><span class="line">                    <span class="string">"message"</span>: <span class="string">"Baby, that's enough now. Let's get back to work!"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">    	    	id+=id</span><br><span class="line">    	    	time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">	    get_state()</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">	    ws.send(json.dumps(&#123;</span><br><span class="line">	                <span class="string">"id"</span>: id,</span><br><span class="line">	                <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">	                <span class="string">"domain"</span>: id_array[i][<span class="number">0</span>:id_array[i].find(<span class="string">"."</span>)],</span><br><span class="line">	                <span class="string">"service"</span>: <span class="string">"turn_off"</span>,</span><br><span class="line">	                <span class="string">"service_data"</span>: &#123;</span><br><span class="line">	                <span class="string">"entity_id"</span>: id_array[i]</span><br><span class="line">	                &#125;</span><br><span class="line">	                &#125;))</span><br><span class="line">	    id=id+<span class="number">1</span></span><br><span class="line">	    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">	    get_state()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randomcolor</span><span class="params">(ws, lightid)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> id</span><br><span class="line">    <span class="keyword">global</span> c</span><br><span class="line">    random_red = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    random_green = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    random_blue = randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    c=(random_red, random_green, random_blue)</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">        <span class="string">"id"</span>: id,</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">        <span class="string">"domain"</span>: lightid[<span class="number">0</span>:(lightid.find(<span class="string">"."</span>))], <span class="comment"># "light",</span></span><br><span class="line">        <span class="string">"service"</span>: <span class="string">"turn_on"</span>,</span><br><span class="line">        <span class="string">"service_data"</span>: &#123;</span><br><span class="line">            <span class="string">"entity_id"</span>: lightid,</span><br><span class="line">	    <span class="string">"rgb_color"</span>: [str(c[<span class="number">0</span>]),str(c[<span class="number">1</span>]),str(c[<span class="number">2</span>])]</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"toggle id "</span>+str(id)</span><br><span class="line">    id=id+<span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    get_state()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">togglelight</span><span class="params">(ws, lightid)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> id</span><br><span class="line">    ws.send(json.dumps(&#123;</span><br><span class="line">        <span class="string">"id"</span>: id,</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"call_service"</span>,</span><br><span class="line">        <span class="string">"domain"</span>: lightid[<span class="number">0</span>:(lightid.find(<span class="string">"."</span>))],  <span class="comment">#"light",</span></span><br><span class="line">        <span class="string">"service"</span>: <span class="string">"toggle"</span>,</span><br><span class="line">        <span class="string">"service_data"</span>: &#123;</span><br><span class="line">            <span class="string">"entity_id"</span>: lightid</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"!!!!!!!!!!"</span>+lightid[<span class="number">0</span>:(lightid.find(<span class="string">"."</span>))] </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"toggle id "</span>+str(id)</span><br><span class="line">    id=id+<span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    get_state()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showpic</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> pic_makeparty_rotate</span><br><span class="line">    <span class="keyword">if</span> partyison==<span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">print</span> b</span><br><span class="line">        <span class="keyword">print</span> c</span><br><span class="line">        <span class="keyword">print</span> pic_array[i]()</span><br><span class="line">        sense.set_pixels(pic_array[i]())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">	pic_makeparty_rotate+=<span class="number">90</span></span><br><span class="line">	<span class="keyword">if</span> pic_makeparty_rotate&gt;=<span class="number">360</span>:</span><br><span class="line">	    pic_makeparty_rotate-=<span class="number">360</span></span><br><span class="line">	sense.set_rotation(pic_makeparty_rotate,redraw=<span class="literal">False</span>)</span><br><span class="line">	sense.set_pixels(pic_makeparty())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_led_array</span><span class="params">(i)</span>:</span></span><br><span class="line">    sense.set_pixels(pic_array[i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getrealacceleratiion</span><span class="params">(acceleration)</span>:</span></span><br><span class="line">    x = acceleration[<span class="string">'x'</span>]</span><br><span class="line">    y = acceleration[<span class="string">'y'</span>]</span><br><span class="line">    z = acceleration[<span class="string">'z'</span>]</span><br><span class="line"></span><br><span class="line">    gValq=numpy.square(x)+numpy.square(y)+numpy.square(z)<span class="number">-1</span></span><br><span class="line">    <span class="keyword">if</span> gValq&lt;=<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> numpy.sqrt(gValq)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(ws, message)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> id</span><br><span class="line">    <span class="keyword">global</span> i</span><br><span class="line">    <span class="keyword">global</span> c</span><br><span class="line">    <span class="keyword">global</span> resultid</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mainloop</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            sense.stick.direction_left=pushed_left</span><br><span class="line">            sense.stick.direction_right=pushed_right</span><br><span class="line">        	sense.stick.direction_middle=pushed_middle</span><br><span class="line">            time.sleep(<span class="number">0.2</span>)</span><br><span class="line">            acceleration = sense.get_accelerometer_raw()</span><br><span class="line">            realacceleration= getrealacceleratiion(acceleration)</span><br><span class="line">            <span class="keyword">print</span> realacceleration</span><br><span class="line">        <span class="keyword">if</span> realacceleration &gt; <span class="number">5</span>:</span><br><span class="line">    	<span class="keyword">print</span> <span class="string">"make party"</span></span><br><span class="line">    	makeparty()</span><br><span class="line">    	time.sleep(<span class="number">0.2</span>)</span><br><span class="line">            <span class="keyword">elif</span> realacceleration &gt;<span class="number">1</span>:</span><br><span class="line">    	<span class="keyword">if</span> id_array[i]==<span class="string">"light.lichtsstreifen"</span>:</span><br><span class="line">    	    randomcolor(ws,id_array[i])</span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">                    togglelight(ws,id_array[i])</span><br><span class="line">                <span class="keyword">print</span> id_array[i]+<span class="string">" toggled!"</span></span><br><span class="line">                time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    </span><br><span class="line">    message=json.loads(message)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"type"</span>]==<span class="string">"auth_required"</span>:</span><br><span class="line">        ws.send(json.dumps((&#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"auth"</span>,</span><br><span class="line">         <span class="string">"access_token"</span>: MY_TOKEN</span><br><span class="line">        &#125;)))</span><br><span class="line">    <span class="keyword">elif</span> message[<span class="string">"type"</span>]==<span class="string">"auth_ok"</span>:</span><br><span class="line">        get_state()</span><br><span class="line">    thread.start_new_thread(mainloop, ())</span><br><span class="line">    <span class="keyword">elif</span> message[<span class="string">"type"</span>]==<span class="string">"auth_invalid"</span>:</span><br><span class="line">        <span class="keyword">print</span> message[<span class="string">"message"</span>]</span><br><span class="line">    <span class="keyword">elif</span> message[<span class="string">"type"</span>]==<span class="string">"result"</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"new MESSAGE!"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"resultid "</span>+str(resultid)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"id"</span>]==resultid:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"STATE RECEIVED!"</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> message[<span class="string">"result"</span>]:</span><br><span class="line">                <span class="keyword">if</span> item[<span class="string">"entity_id"</span>]==id_array[i]:</span><br><span class="line">                    <span class="keyword">if</span> item[<span class="string">"state"</span>]==<span class="string">"on"</span>: </span><br><span class="line">    		    <span class="keyword">if</span> <span class="string">"rgb_color"</span> <span class="keyword">in</span> item[<span class="string">"attributes"</span>]:</span><br><span class="line">    			tempcol=item[<span class="string">"attributes"</span>][<span class="string">"rgb_color"</span>]</span><br><span class="line">    			<span class="keyword">print</span> tempcol</span><br><span class="line">    			c=(tempcol[<span class="number">0</span>],tempcol[<span class="number">1</span>],tempcol[<span class="number">2</span>])</span><br><span class="line">    		    <span class="keyword">else</span>:</span><br><span class="line">    			c=bright</span><br><span class="line">    			<span class="keyword">print</span> <span class="string">"b"</span></span><br><span class="line">                            showpic(i)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">    		    <span class="keyword">print</span> <span class="string">"OFF"</span></span><br><span class="line">                            c=dark</span><br><span class="line">                            showpic(i)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                c=unconnected</span><br><span class="line">                showpic(i)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_error</span><span class="params">(ws, error)</span>:</span></span><br><span class="line">    print(error)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_close</span><span class="params">(ws)</span>:</span></span><br><span class="line">    sense.clear()</span><br><span class="line">    print(<span class="string">"### closed ###"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_open</span><span class="params">(ws)</span>:</span></span><br><span class="line">    print(<span class="string">"connection opened"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    websocket.enableTrace(<span class="literal">True</span>)</span><br><span class="line">    ws = websocket.WebSocket()</span><br><span class="line">    ws = websocket.WebSocketApp(<span class="string">"ws://localhost:8123/api/websocket"</span>,</span><br><span class="line">                              on_message = on_message,</span><br><span class="line">                              on_error = on_error,</span><br><span class="line">                              on_close = on_close)</span><br><span class="line">    ws.on_open = on_open</span><br><span class="line">    ws.run_forever()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.thingsjar.com/2019/01/13/2019-01-13-How-to-use-PPM-signal-to-control-your-RC-car-with-a-raspberry-pi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Thingsjar">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thingsjar">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/13/2019-01-13-How-to-use-PPM-signal-to-control-your-RC-car-with-a-raspberry-pi/" class="post-title-link" itemprop="url">How to use PPM signal to control your RC car with a raspberry pi</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-13 19:55:09" itemprop="dateCreated datePublished" datetime="2019-01-13T19:55:09+00:00">2019-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-26 19:08:35" itemprop="dateModified" datetime="2019-12-26T19:08:35+00:00">2019-12-26</time>
              </span>

          
            <span id="/2019/01/13/2019-01-13-How-to-use-PPM-signal-to-control-your-RC-car-with-a-raspberry-pi/" class="post-meta-item leancloud_visitors" data-flag-title="How to use PPM signal to control your RC car with a raspberry pi" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/01/13/2019-01-13-How-to-use-PPM-signal-to-control-your-RC-car-with-a-raspberry-pi/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/13/2019-01-13-How-to-use-PPM-signal-to-control-your-RC-car-with-a-raspberry-pi/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>The RC car I use is a Tamiya 1/10 Mercedes-Benz Unimog 425 truck with the CC-01 (Cross Country) chassis. With a full-time 4WD system, front double wishbone, rear 4-link rigid suspension and RS-540 E-Motor, it is a multi-purpose truck with excellent off-road performance.<br><img src="https://cdn.simba-dickie-group.de/media/web-tamiya/products/300058609/00/detail_zoom/1-10-rc-mercedes-benz-unimog-425cc-01-300058609_00.jpeg?v=1544096047" alt=""><br>If we want to control a electric motor, the most common way is to use a PWM signal to control a ESC (Electronic speed control). There is an ESC included in the tamiya model, but the input signal is PPM signal instead of PWM.</p>
<p>So, what’s the difference betwen PPM and PWM? The RC transmitter normally has at least one channel for throttle and one for steering. The transmitter encodes both signal channels in a single pulse and sends it to the receiver. This process is also called a pulse-position modulation (PPM). The receiver decodes the signal and sends the throttle and steering signals to the RS-540 and the steering servo motor separately.</p>
<p>How does the signal to control RS-540 look like? I used an USB Logic Analyser to catch the PPM signal which is sent to RS-540.</p>
<p><img src="https://github.com/thingsjar/thingsjar/blob/master/images/Bildschirmfoto%202019-01-10%20um%2022.37.23.png?raw=true" alt="Bildschirmfoto 2019-01-10 um 22.37.23"></p>
<p>As you can see, it’s a pulse with repeated cycles. One cycle is about 20ms with 1-2ms high level. For example, 1.5ms is the neutral throttle position, 1ms is for the maximal forward speed and 2ms for the minimal reverse. To have a look directly into the protocol, I measured the PPM signal as follows.</p>
<p><img src="https://github.com/thingsjar/thingsjar/blob/master/images/Bildschirmfoto%202019-01-10%20um%2022.40.14.png?raw=true" alt="Bildschirmfoto 2019-01-10 um 22.40.14"></p>
<p>Here is the data which I measured from my RC receiver when I put the throttle to neutral, max forward, max reverse position:</p>
<table>
<thead>
<tr>
<th>throttle pos.</th>
<th>high-level time</th>
<th>total cycle</th>
</tr>
</thead>
<tbody><tr>
<td>neutral</td>
<td>1.45ms</td>
<td>19.75ms</td>
</tr>
<tr>
<td>max. reverse</td>
<td>1.75ms</td>
<td>19.65ms</td>
</tr>
<tr>
<td>max. forward</td>
<td>1.15ms</td>
<td>19.55ms</td>
</tr>
</tbody></table>
<p>So if we generate a similar signal and send it into the ESC, the problem would be solved.</p>
<p>The first problem is, how to control time very precisely with an accuracy of 1-10us using a raspberry pi? I tried to use the time.sleep() function and it is not accurate enough. So I used the <strong>PIGPIO</strong> library. What do we have to do? Just install pigpio with the following command on the raspberry pi:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install pigpio python-pigpio python3-pigpio</span><br></pre></td></tr></table></figure>

<p>then use this cmd to start the pigpio daemon.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pigpiod</span><br></pre></td></tr></table></figure>

<p>if you used this cmd, you have to input this cmd again to start the pigpio daemon when you reboot your system. If you want to run pigpiod automatically on boot, you can use following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable pigpiod</span><br></pre></td></tr></table></figure>

<p>So the pigpiod launches the pigpio library as a daemon in the background and accepts commands from the pipe and socket interface. That’s why you can use another computer, which is connected to the same local network, or even via internet to read and write all GPIOs of your raspberry pi.</p>
<p>Of course, you also have to install pigpio library on your computer.</p>
<p>I used <code>pip install gpiozero pigpio</code> to install the library on my Mac OS. If you use other operating systems or python version, you can refer <a href="https://gpiozero.readthedocs.io/en/stable/remote_gpio.html" target="_blank" rel="noopener">here</a> for more information.</p>
<p>After that, I connected a LED light to GPIO 14 of my raspberry pi and used the following script to test if it really works:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pigpio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">pi=pigpio.pi(host=<span class="string">"192.168.2.117"</span>,) <span class="comment">#change here with your own IP of raspberry pi.</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> pi.connected:</span><br><span class="line">exit()</span><br><span class="line">pi.write(<span class="number">14</span>, <span class="number">0</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">pi.write(<span class="number">14</span>, <span class="number">1</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">pi.write(<span class="number">14</span>,<span class="number">0</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pi.stop()</span><br></pre></td></tr></table></figure>

<p>The LED is blinking, so it worked!</p>
<p>here is the skript for the PPM module:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># PPM.py</span></span><br><span class="line"><span class="comment"># 2919-01-11</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pigpio</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span>:</span></span><br><span class="line"></span><br><span class="line">GAP=<span class="number">100</span></span><br><span class="line">WAVES=<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, pi, gpio, channels=<span class="number">1</span>, frame_ms=<span class="number">19.65</span>)</span>:</span></span><br><span class="line">self.pi = pi</span><br><span class="line">self.gpio = gpio</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> frame_ms &lt; <span class="number">5</span>:</span><br><span class="line">frame_ms = <span class="number">5</span></span><br><span class="line">channels = <span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> frame_ms &gt; <span class="number">100</span>:</span><br><span class="line">frame_ms = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">self.frame_us = int(frame_ms * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> channels &lt; <span class="number">1</span>:</span><br><span class="line">channels = <span class="number">1</span></span><br><span class="line"><span class="keyword">elif</span> channels &gt; (frame_ms // <span class="number">2</span>):</span><br><span class="line">channels = int(frame_ms // <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">self.channels = channels</span><br><span class="line"></span><br><span class="line">self._widths = [<span class="number">1000</span>] * channels <span class="comment"># set each channel to minimum pulse width</span></span><br><span class="line"></span><br><span class="line">self._wid = [<span class="literal">None</span>]*self.WAVES</span><br><span class="line">self._next_wid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">pi.write(gpio, pigpio.LOW)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update</span><span class="params">(self)</span>:</span></span><br><span class="line">wf =[]</span><br><span class="line">micros = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> self._widths:</span><br><span class="line">wf.append(pigpio.pulse(<span class="number">0</span>, <span class="number">1</span>&lt;&lt;self.gpio, self.GAP))</span><br><span class="line">wf.append(pigpio.pulse(<span class="number">1</span>&lt;&lt;self.gpio, <span class="number">0</span>, i))</span><br><span class="line">micros += (i+self.GAP)</span><br><span class="line"><span class="comment">#micros += i</span></span><br><span class="line"><span class="comment"># off for the remaining frame period</span></span><br><span class="line">wf.append(pigpio.pulse(<span class="number">0</span>, <span class="number">1</span>&lt;&lt;self.gpio, self.frame_us-micros))</span><br><span class="line"></span><br><span class="line">self.pi.wave_add_generic(wf)</span><br><span class="line">wid = self.pi.wave_create()</span><br><span class="line">self.pi.wave_send_repeat(wid)</span><br><span class="line">self._wid[self._next_wid] = wid</span><br><span class="line"><span class="comment">#rint("create", self._next_wid, "with", wid)</span></span><br><span class="line"></span><br><span class="line">self._next_wid += <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> self._next_wid &gt;= self.WAVES:</span><br><span class="line">self._next_wid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">wid = self._wid[self._next_wid]</span><br><span class="line"><span class="keyword">if</span> wid <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">print(<span class="string">"delete"</span>, self._next_wid, <span class="string">"with"</span>, wid)</span><br><span class="line">self.pi.wave_delete(wid)</span><br><span class="line">self._wid[self._next_wid] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_channel</span><span class="params">(self, channel, width)</span>:</span></span><br><span class="line">self._widths[channel] = width</span><br><span class="line">self._update()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_channels</span><span class="params">(self, widths)</span>:</span></span><br><span class="line">self._widths[<span class="number">0</span>:len(widths)] = widths[<span class="number">0</span>:self.channels]</span><br><span class="line">self._update()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cancel</span><span class="params">(self)</span>:</span></span><br><span class="line">self.pi.wave_tx_stop()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> self._wid:</span><br><span class="line"><span class="keyword">if</span> i <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">self.pi.wave_delete(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> PPM</span><br><span class="line"><span class="keyword">import</span> pigpio</span><br><span class="line"></span><br><span class="line">pi = pigpio.pi(host=<span class="string">"192.168.2.117"</span>) <span class="comment">#change here with your own IP of raspberry pi.</span></span><br><span class="line">pi.wave_clear()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> pi.connected:</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ppm = PPM.X(pi, <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">updates = <span class="number">0</span></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> chan <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line"><span class="keyword">for</span> pw <span class="keyword">in</span> range(<span class="number">1000</span>, <span class="number">2000</span>, <span class="number">5</span>):</span><br><span class="line">ppm.update_channel(chan, pw)</span><br><span class="line">updates += <span class="number">1</span></span><br><span class="line">time.sleep(<span class="number">0.03</span>)</span><br><span class="line">end = time.time()</span><br><span class="line">secs = end - start</span><br><span class="line">print(<span class="string">"&#123;&#125; updates in &#123;:.1f&#125; seconds (&#123;&#125;/s)"</span>.format(updates, secs, int(updates/secs)))</span><br><span class="line"></span><br><span class="line">ppm.update_channels([<span class="number">1000</span>, <span class="number">2000</span>, <span class="number">1000</span>, <span class="number">2000</span>, <span class="number">1000</span>, <span class="number">2000</span>, <span class="number">1000</span>, <span class="number">2000</span>])</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ppm.cancel()</span><br><span class="line"></span><br><span class="line">pi.stop()</span><br></pre></td></tr></table></figure>

<p>But first of all, you have to do the high point set up again for your RC car according to your instruction of ESC. Connect the GND and Signal wire from the ESC to the GPIO of your raspberry pi. Just as an example, the steps for my ESC are:</p>
<ul>
<li>switch on transmitter -&gt; which means I will start using my python script to send the signal of 1.5ms high-level cycles.</li>
<li>switch on receiver</li>
<li>While holding down set button on ESC, check that LED flashes in the order RED-&gt;Green-&gt;Orange-&gt;RED</li>
<li>Release set button when LED lights up RED. LED will start to single flash Red.</li>
<li>Apply full throttle (here I will start using python to send the signal of 1ms high-level cycles) and press set button once,, if procedure has been performed correctly, LED will start to double flash.</li>
<li>Apply full brake (here I will start using python to send the signal with 2 ms high-level cycles) and press set button once. If procedure has been performed correctly, LED will turn off.</li>
</ul>
<p>So now the ESC has learned the maximal position (the length of high-level in a 20ms cycle) and you can use the script to control your motor. try the following script.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> PPM</span><br><span class="line"><span class="keyword">import</span> pigpio</span><br><span class="line"></span><br><span class="line">pi = pigpio.pi(host=<span class="string">"192.168.2.117"</span>)</span><br><span class="line">pi.wave_clear()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> pi.connected:</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line">ppm = PPM.X(pi, <span class="number">14</span>)</span><br><span class="line">print(<span class="string">"Neutral for 5 seconds"</span>)</span><br><span class="line">ppm.update_channel(<span class="number">0</span>, <span class="number">1500</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">"accelerate pedal from 0% to 100%"</span>)</span><br><span class="line"><span class="keyword">for</span> pw <span class="keyword">in</span> range(<span class="number">1500</span>,<span class="number">1000</span>,<span class="number">-5</span>):</span><br><span class="line">ppm.update_channel(<span class="number">0</span>,pw)</span><br><span class="line">updates +=<span class="number">1</span></span><br><span class="line">time.sleep(<span class="number">0.03</span>)</span><br><span class="line">print(<span class="string">"decelerate from 100% to 20%"</span>)</span><br><span class="line"><span class="keyword">for</span> pw <span class="keyword">in</span> range(<span class="number">1000</span>,<span class="number">1400</span>,<span class="number">5</span>):</span><br><span class="line">ppm.update_channel(<span class="number">0</span>,pw)</span><br><span class="line">updates +=<span class="number">1</span></span><br><span class="line">time.sleep(<span class="number">0.03</span>)</span><br><span class="line">print(<span class="string">"brake from 20% to 0%"</span>)</span><br><span class="line">ppm.update_channel(<span class="number">0</span>,<span class="number">1700</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(<span class="string">"brake released, neutral for 5s"</span>)</span><br><span class="line">ppm.update_channel(<span class="number">0</span>, <span class="number">1500</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">"reverse to 100%"</span>)</span><br><span class="line">ppm.update_channel(<span class="number">0</span>,<span class="number">2000</span>)</span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">"Neutral for 5 seconds, programm finished."</span>)</span><br><span class="line">ppm.update_channel(<span class="number">0</span>, <span class="number">1500</span>)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">ppm.cancel()</span><br><span class="line">pi.stop()</span><br></pre></td></tr></table></figure>

<p>the motor will accelerate from 0% to 100% and decelerate from 100% to 20%, after that, the motor will be stopped immediately. after 5 seconds staying in neutral position, it will start to accelerate in the reverse direction form 0 to 100% and after that the motor will be stopped.  </p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mivJ6fg7IYY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>It is the same to control the servo motor for steering. After this you can control your rc car with a computer. If you expose your PIGPIO port (default 8888) to internet, you can also control it via internet when you are not at home. What you need is to add a camera to it, so that you can see where you are going. With a combination with OpenCV and TensorFlow, your car can even recognize the environment and realize part of the autonomous driving.<br><img src="/images/IMG_3715.jpeg" alt=""></p>
<p><strong>Reference</strong></p>
<ul>
<li><p><a href="https://www.raspberrypi.org/forums/viewtopic.php?t=66445&amp;start=100" target="_blank" rel="noopener">https://www.raspberrypi.org/forums/viewtopic.php?t=66445&amp;start=100</a></p>
</li>
<li><p><a href="https://gpiozero.readthedocs.io/en/stable/remote_gpio.html" target="_blank" rel="noopener">https://gpiozero.readthedocs.io/en/stable/remote_gpio.html</a></p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Pulse-position_modulation" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pulse-position_modulation</a></p>
</li>
<li><p><a href="http://abyz.me.uk/rpi/pigpio/index.html" target="_blank" rel="noopener">http://abyz.me.uk/rpi/pigpio/index.html</a></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Thingsjar</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element">
    <a onclick="Chatra('openChat', true)"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thingsjar</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.1.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  






  <script>
    (function(d, w, c) {
      w.ChatraID = 'eiLK4pY54uTgbcmvu';
      var s = d.createElement('script');
      w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
      };
      s.async = true;
      s.src = 'https://call.chatra.io/chatra.js';
      if (d.head) d.head.appendChild(s);
    })(document, window, 'Chatra');
  </script>









  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: true,
      appId: 'KKH83bXpcfeMBHaDSPTEg0UU-gzGzoHsz',
      appKey: 'X732Rn66D3o7ayrOSjHuuAFG',
      placeholder: "Just go go",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: true,
      lang: 'en' || 'zh-cn',
      path: location.pathname,
      recordIP: true,
      serverURLs: ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
